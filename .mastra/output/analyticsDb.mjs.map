{"version":3,"file":"analyticsDb.mjs","sources":["../../src/mastra/storage/pgClient.ts","../../src/mastra/storage/analyticsDb.ts"],"sourcesContent":["import pg from \"pg\";\n\nconst { Pool } = pg;\n\n/**\n * PostgreSQL Client for Direct Database Operations\n * Used for storing marketing analytics data\n */\n\nlet pool: pg.Pool | null = null;\n\nexport function getPgPool(): pg.Pool {\n  if (!pool) {\n    const connectionString = process.env.DATABASE_URL;\n    if (!connectionString) {\n      console.warn(\"⚠️ DATABASE_URL not set, database features will be limited\");\n      // Return a dummy pool that won't crash but will log warnings\n      return {\n        query: async () => {\n          console.warn(\"⚠️ Database query attempted but DATABASE_URL not configured\");\n          return { rows: [] };\n        },\n      } as any;\n    }\n    pool = new Pool({\n      connectionString,\n      max: 20,\n      idleTimeoutMillis: 30000,\n      connectionTimeoutMillis: 2000,\n    });\n  }\n  return pool;\n}\n\n/**\n * Initialize analytics tables in PostgreSQL\n */\nexport async function initializeAnalyticsTables(): Promise<void> {\n  if (!process.env.DATABASE_URL) {\n    console.warn(\"⚠️ Skipping analytics table initialization - DATABASE_URL not configured\");\n    return;\n  }\n  \n  const pool = getPgPool();\n  \n  try {\n    // Create analytics_data table\n    await pool.query(`\n      CREATE TABLE IF NOT EXISTS analytics_data (\n        id VARCHAR(255) PRIMARY KEY,\n        source VARCHAR(100) NOT NULL,\n        metric_type VARCHAR(100) NOT NULL,\n        date TIMESTAMP NOT NULL,\n        data JSONB NOT NULL,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      );\n    `);\n\n    // Create index for querying by source and date\n    await pool.query(`\n      CREATE INDEX IF NOT EXISTS idx_analytics_source_date \n      ON analytics_data(source, date DESC);\n    `);\n\n    console.log(\"✅ Analytics tables initialized successfully\");\n  } catch (error) {\n    console.error(\"❌ Error initializing analytics tables:\", error);\n    // Don't throw - allow app to start even if DB init fails\n    console.warn(\"⚠️ Continuing without analytics database\");\n  }\n}\n\n/**\n * Execute a parameterized query\n */\nexport async function executeQuery<T = any>(\n  query: string,\n  params: any[] = []\n): Promise<T[]> {\n  const pool = getPgPool();\n  \n  try {\n    const result = await pool.query(query, params);\n    return result.rows as T[];\n  } catch (error) {\n    console.error(\"Database query error:\", error);\n    throw error;\n  }\n}\n\n/**\n * Insert or update a record\n */\nexport async function upsertRecord(\n  table: string,\n  id: string,\n  data: Record<string, any>\n): Promise<void> {\n  const pool = getPgPool();\n  \n  const columns = Object.keys(data);\n  const values = Object.values(data);\n  const placeholders = values.map((_, i) => `$${i + 2}`).join(\", \");\n  const updates = columns.map((col, i) => `${col} = $${i + 2}`).join(\", \");\n\n  const query = `\n    INSERT INTO ${table} (id, ${columns.join(\", \")})\n    VALUES ($1, ${placeholders})\n    ON CONFLICT (id) DO UPDATE SET ${updates}\n  `;\n\n  try {\n    await pool.query(query, [id, ...values]);\n  } catch (error) {\n    console.error(`Error upserting record in ${table}:`, error);\n    throw error;\n  }\n}\n","import { getPgPool, executeQuery, initializeAnalyticsTables } from \"./pgClient\";\n\n/**\n * Database Helper for Marketing Analytics Data\n * Stores data from Google Analytics, Meta Pixel, TikTok Pixel, Microsoft Clarity\n */\n\nexport interface AnalyticsRecord {\n  id?: string;\n  source: string;\n  metric_type: string;\n  date: string;\n  data: any;\n  created_at?: string;\n}\n\n// Initialize tables on module load\ninitializeAnalyticsTables().catch(console.error);\n\n/**\n * Store analytics data in PostgreSQL\n */\nexport async function storeAnalyticsData(record: AnalyticsRecord): Promise<void> {\n  const pool = getPgPool();\n  \n  try {\n    const id = record.id || `${record.source}-${record.metric_type}-${Date.now()}`;\n    const query = `\n      INSERT INTO analytics_data (id, source, metric_type, date, data, created_at)\n      VALUES ($1, $2, $3, $4, $5, $6)\n      ON CONFLICT (id) DO UPDATE \n      SET data = EXCLUDED.data, created_at = EXCLUDED.created_at\n    `;\n    \n    const values = [\n      id,\n      record.source,\n      record.metric_type,\n      record.date,\n      JSON.stringify(record.data),\n      record.created_at || new Date().toISOString(),\n    ];\n    \n    await pool.query(query, values);\n    console.log(\"✅ Stored analytics data:\", { id, source: record.source, type: record.metric_type });\n    \n  } catch (error) {\n    console.error(\"❌ Error storing analytics data:\", error);\n    throw error;\n  }\n}\n\n/**\n * Retrieve analytics data from PostgreSQL\n */\nexport async function getAnalyticsData(\n  source?: string,\n  startDate?: string,\n  endDate?: string\n): Promise<AnalyticsRecord[]> {\n  try {\n    let query = \"SELECT * FROM analytics_data WHERE 1=1\";\n    const params: any[] = [];\n    let paramCount = 1;\n    \n    if (source) {\n      query += ` AND source = $${paramCount}`;\n      params.push(source);\n      paramCount++;\n    }\n    \n    if (startDate) {\n      query += ` AND date >= $${paramCount}`;\n      params.push(startDate);\n      paramCount++;\n    }\n    \n    if (endDate) {\n      query += ` AND date <= $${paramCount}`;\n      params.push(endDate);\n      paramCount++;\n    }\n    \n    query += \" ORDER BY date DESC LIMIT 100\";\n    \n    const results = await executeQuery<AnalyticsRecord>(query, params);\n    console.log(`✅ Retrieved ${results.length} analytics records`);\n    return results;\n  } catch (error) {\n    console.error(\"❌ Error retrieving analytics data:\", error);\n    throw error;\n  }\n}\n\n/**\n * Store SEO audit results\n */\nexport async function storeSeoAudit(audit: {\n  websiteUrl: string;\n  score: number;\n  issues: any[];\n  auditDate: string;\n}): Promise<void> {\n  try {\n    const record: AnalyticsRecord = {\n      id: `seo-audit-${audit.websiteUrl.replace(/[^a-zA-Z0-9]/g, '-')}-${Date.now()}`,\n      source: \"seo_analysis\",\n      metric_type: \"audit\",\n      date: audit.auditDate,\n      data: audit,\n    };\n    \n    await storeAnalyticsData(record);\n    console.log(\"✅ Stored SEO audit:\", { url: audit.websiteUrl, score: audit.score });\n  } catch (error) {\n    console.error(\"❌ Error storing SEO audit:\", error);\n    throw error;\n  }\n}\n\n/**\n * Store content opportunity\n */\nexport async function storeContentOpportunity(opportunity: {\n  keyword: string;\n  searchVolume: number;\n  difficulty: number;\n  intent: string;\n  opportunity: string;\n}): Promise<void> {\n  try {\n    console.log(\"Storing content opportunity:\", { keyword: opportunity.keyword });\n    \n    const record: AnalyticsRecord = {\n      id: `content-opp-${opportunity.keyword}-${new Date().toISOString()}`,\n      source: \"search_query_analysis\",\n      metric_type: \"opportunity\",\n      date: new Date().toISOString(),\n      data: opportunity,\n    };\n    \n    await storeAnalyticsData(record);\n  } catch (error) {\n    console.error(\"Error storing content opportunity:\", error);\n    throw error;\n  }\n}\n\n/**\n * Store generated content\n */\nexport async function storeGeneratedContent(content: {\n  contentType: string;\n  keyword: string;\n  content: string;\n  seoScore: number;\n}): Promise<void> {\n  try {\n    console.log(\"Storing generated content:\", { type: content.contentType, keyword: content.keyword });\n    \n    const record: AnalyticsRecord = {\n      id: `content-${content.contentType}-${content.keyword}-${new Date().toISOString()}`,\n      source: \"content_generation\",\n      metric_type: content.contentType,\n      date: new Date().toISOString(),\n      data: content,\n    };\n    \n    await storeAnalyticsData(record);\n  } catch (error) {\n    console.error(\"Error storing generated content:\", error);\n    throw error;\n  }\n}\n\n/**\n * Store SEO schema snapshot data\n */\nexport async function storeSeoSchemaSnapshot(snapshot: {\n  websiteUrl: string;\n  schemaTypes: string[];\n  missingTypes: string[];\n  warnings: string[];\n  detectedIssues: Array<{\n    type: string;\n    severity: \"critical\" | \"high\" | \"medium\" | \"low\";\n    message: string;\n  }>;\n  crawledAt: string;\n}): Promise<void> {\n  try {\n    const record: AnalyticsRecord = {\n      id: `schema-${snapshot.websiteUrl.replace(/[^a-zA-Z0-9]/g, '-')}-${snapshot.crawledAt}`,\n      source: \"seo_schema\",\n      metric_type: \"snapshot\",\n      date: snapshot.crawledAt,\n      data: snapshot,\n    };\n\n    await storeAnalyticsData(record);\n  } catch (error) {\n    console.error(\"Error storing SEO schema snapshot:\", error);\n    throw error;\n  }\n}\n\n/**\n * Store keyword radar / opportunity insights\n */\nexport async function storeKeywordRadarInsights(payload: {\n  industry: string;\n  focusKeywords: Array<{\n    keyword: string;\n    searchVolume: number;\n    difficulty: number;\n    opportunityScore: number;\n    intent: string;\n  }>;\n  trendSignals: Array<{ topic: string; delta: string }>;\n  generatedAt: string;\n}): Promise<void> {\n  try {\n    const record: AnalyticsRecord = {\n      id: `keyword-radar-${payload.industry}-${payload.generatedAt}`,\n      source: \"keyword_radar\",\n      metric_type: \"opportunity_map\",\n      date: payload.generatedAt,\n      data: payload,\n    };\n\n    await storeAnalyticsData(record);\n  } catch (error) {\n    console.error(\"Error storing keyword radar insights:\", error);\n    throw error;\n  }\n}\n\n/**\n * Persist automation decisions (e.g., should create content)\n */\nexport async function storeAutomationDecision(decision: {\n  websiteUrl: string;\n  decisionType: string;\n  shouldAct: boolean;\n  confidence: number;\n  reasons: string[];\n  evaluatedAt: string;\n}): Promise<void> {\n  try {\n    const record: AnalyticsRecord = {\n      id: `decision-${decision.decisionType}-${decision.evaluatedAt}`,\n      source: \"automation_decision\",\n      metric_type: decision.decisionType,\n      date: decision.evaluatedAt,\n      data: decision,\n    };\n\n    await storeAnalyticsData(record);\n  } catch (error) {\n    console.error(\"Error storing automation decision:\", error);\n    throw error;\n  }\n}\n\n/**\n * Store monitoring telemetry pulses\n */\nexport async function storeMonitoringPulse(pulse: {\n  websiteUrl: string;\n  signal: string;\n  severity: \"info\" | \"warning\" | \"critical\";\n  metrics: Record<string, any>;\n  observedAt: string;\n}): Promise<void> {\n  try {\n    const record: AnalyticsRecord = {\n      id: `monitoring-${pulse.signal}-${pulse.observedAt}`,\n      source: \"monitoring\",\n      metric_type: pulse.signal,\n      date: pulse.observedAt,\n      data: pulse,\n    };\n\n    await storeAnalyticsData(record);\n  } catch (error) {\n    console.error(\"Error storing monitoring pulse:\", error);\n    throw error;\n  }\n}\n"],"names":["pool"],"mappings":";;AAEA,MAAM,EAAE,MAAK,GAAI,EAAA;AAOjB,IAAI,IAAA,GAAuB,IAAA;AAEpB,SAAS,SAAA,GAAqB;AACnC,EAAA,IAAI,CAAC,IAAA,EAAM;AACT,IAAA,MAAM,gBAAA,GAAmB,QAAQ,GAAA,CAAI,YAAA;AACrC,IAAA,IAAI,CAAC,gBAAA,EAAkB;AACrB,MAAA,OAAA,CAAQ,KAAK,sEAA4D,CAAA;AAEzE,MAAA,OAAO;AAAA,QACL,OAAO,YAAY;AACjB,UAAA,OAAA,CAAQ,KAAK,uEAA6D,CAAA;AAC1E,UAAA,OAAO,EAAE,IAAA,EAAM,EAAC,EAAE;AAAA,QACpB;AAAA,OACF;AAAA,IACF;AACA,IAAA,IAAA,GAAO,IAAI,IAAA,CAAK;AAAA,MACd,gBAAA;AAAA,MACA,GAAA,EAAK,EAAA;AAAA,MACL,iBAAA,EAAmB,GAAA;AAAA,MACnB,uBAAA,EAAyB;AAAA,KAC1B,CAAA;AAAA,EACH;AACA,EAAA,OAAO,IAAA;AACT;AAKA,eAAsB,yBAAA,GAA2C;AAC/D,EAAA,IAAI,CAAC,OAAA,CAAQ,GAAA,CAAI,YAAA,EAAc;AAC7B,IAAA,OAAA,CAAQ,KAAK,oFAA0E,CAAA;AACvF,IAAA;AAAA,EACF;AAEA,EAAA,MAAMA,QAAO,SAAA,EAAU;AAEvB,EAAA,IAAI;AAEF,IAAA,MAAMA,MAAK,KAAA,CAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAAA,CAShB,CAAA;AAGD,IAAA,MAAMA,MAAK,KAAA,CAAM;AAAA;AAAA;AAAA,IAAA,CAGhB,CAAA;AAED,IAAA,OAAA,CAAQ,IAAI,kDAA6C,CAAA;AAAA,EAC3D,SAAS,KAAA,EAAO;AACd,IAAA,OAAA,CAAQ,KAAA,CAAM,+CAA0C,KAAK,CAAA;AAE7D,IAAA,OAAA,CAAQ,KAAK,oDAA0C,CAAA;AAAA,EACzD;AACF;;ACrDA,yBAAA,EAA0B,CAAE,KAAA,CAAM,OAAA,CAAQ,KAAK,CAAA;AAK/C,eAAsB,mBAAmB,MAAA,EAAwC;AAC/E,EAAA,MAAM,OAAO,SAAA,EAAU;AAEvB,EAAA,IAAI;AACF,IAAA,MAAM,EAAA,GAAK,MAAA,CAAO,EAAA,IAAM,CAAA,EAAG,MAAA,CAAO,MAAM,CAAA,CAAA,EAAI,MAAA,CAAO,WAAW,CAAA,CAAA,EAAI,IAAA,CAAK,GAAA,EAAK,CAAA,CAAA;AAC5E,IAAA,MAAM,KAAA,GAAQ;AAAA;AAAA;AAAA;AAAA;AAAA,IAAA,CAAA;AAOd,IAAA,MAAM,MAAA,GAAS;AAAA,MACb,EAAA;AAAA,MACA,MAAA,CAAO,MAAA;AAAA,MACP,MAAA,CAAO,WAAA;AAAA,MACP,MAAA,CAAO,IAAA;AAAA,MACP,IAAA,CAAK,SAAA,CAAU,MAAA,CAAO,IAAI,CAAA;AAAA,MAC1B,MAAA,CAAO,UAAA,IAAA,iBAAc,IAAI,IAAA,IAAO,WAAA;AAAY,KAC9C;AAEA,IAAA,MAAM,IAAA,CAAK,KAAA,CAAM,KAAA,EAAO,MAAM,CAAA;AAC9B,IAAA,OAAA,CAAQ,GAAA,CAAI,+BAAA,EAA4B,EAAE,EAAA,EAAI,MAAA,EAAQ,OAAO,MAAA,EAAQ,IAAA,EAAM,MAAA,CAAO,WAAA,EAAa,CAAA;AAAA,EAEjG,SAAS,KAAA,EAAO;AACd,IAAA,OAAA,CAAQ,KAAA,CAAM,wCAAmC,KAAK,CAAA;AACtD,IAAA,MAAM,KAAA;AAAA,EACR;AACF;AA+CA,eAAsB,cAAc,KAAA,EAKlB;AAChB,EAAA,IAAI;AACF,IAAA,MAAM,MAAA,GAA0B;AAAA,MAC9B,EAAA,EAAI,CAAA,UAAA,EAAa,KAAA,CAAM,UAAA,CAAW,OAAA,CAAQ,eAAA,EAAiB,GAAG,CAAC,CAAA,CAAA,EAAI,IAAA,CAAK,GAAA,EAAK,CAAA,CAAA;AAAA,MAC7E,MAAA,EAAQ,cAAA;AAAA,MACR,WAAA,EAAa,OAAA;AAAA,MACb,MAAM,KAAA,CAAM,SAAA;AAAA,MACZ,IAAA,EAAM;AAAA,KACR;AAEA,IAAA,MAAM,mBAAmB,MAAM,CAAA;AAC/B,IAAA,OAAA,CAAQ,GAAA,CAAI,4BAAuB,EAAE,GAAA,EAAK,MAAM,UAAA,EAAY,KAAA,EAAO,KAAA,CAAM,KAAA,EAAO,CAAA;AAAA,EAClF,SAAS,KAAA,EAAO;AACd,IAAA,OAAA,CAAQ,KAAA,CAAM,mCAA8B,KAAK,CAAA;AACjD,IAAA,MAAM,KAAA;AAAA,EACR;AACF;AAKA,eAAsB,wBAAwB,WAAA,EAM5B;AAChB,EAAA,IAAI;AACF,IAAA,OAAA,CAAQ,IAAI,8BAAA,EAAgC,EAAE,OAAA,EAAS,WAAA,CAAY,SAAS,CAAA;AAE5E,IAAA,MAAM,MAAA,GAA0B;AAAA,MAC9B,EAAA,EAAI,eAAe,WAAA,CAAY,OAAO,qBAAI,IAAI,IAAA,EAAK,EAAE,WAAA,EAAa,CAAA,CAAA;AAAA,MAClE,MAAA,EAAQ,uBAAA;AAAA,MACR,WAAA,EAAa,aAAA;AAAA,MACb,IAAA,EAAA,iBAAM,IAAI,IAAA,EAAK,EAAE,WAAA,EAAY;AAAA,MAC7B,IAAA,EAAM;AAAA,KACR;AAEA,IAAA,MAAM,mBAAmB,MAAM,CAAA;AAAA,EACjC,SAAS,KAAA,EAAO;AACd,IAAA,OAAA,CAAQ,KAAA,CAAM,sCAAsC,KAAK,CAAA;AACzD,IAAA,MAAM,KAAA;AAAA,EACR;AACF;AAKA,eAAsB,sBAAsB,OAAA,EAK1B;AAChB,EAAA,IAAI;AACF,IAAA,OAAA,CAAQ,GAAA,CAAI,8BAA8B,EAAE,IAAA,EAAM,QAAQ,WAAA,EAAa,OAAA,EAAS,OAAA,CAAQ,OAAA,EAAS,CAAA;AAEjG,IAAA,MAAM,MAAA,GAA0B;AAAA,MAC9B,EAAA,EAAI,CAAA,QAAA,EAAW,OAAA,CAAQ,WAAW,CAAA,CAAA,EAAI,OAAA,CAAQ,OAAO,CAAA,CAAA,EAAA,iBAAI,IAAI,IAAA,EAAK,EAAE,WAAA,EAAa,CAAA,CAAA;AAAA,MACjF,MAAA,EAAQ,oBAAA;AAAA,MACR,aAAa,OAAA,CAAQ,WAAA;AAAA,MACrB,IAAA,EAAA,iBAAM,IAAI,IAAA,EAAK,EAAE,WAAA,EAAY;AAAA,MAC7B,IAAA,EAAM;AAAA,KACR;AAEA,IAAA,MAAM,mBAAmB,MAAM,CAAA;AAAA,EACjC,SAAS,KAAA,EAAO;AACd,IAAA,OAAA,CAAQ,KAAA,CAAM,oCAAoC,KAAK,CAAA;AACvD,IAAA,MAAM,KAAA;AAAA,EACR;AACF;AAKA,eAAsB,uBAAuB,QAAA,EAW3B;AAChB,EAAA,IAAI;AACF,IAAA,MAAM,MAAA,GAA0B;AAAA,MAC9B,EAAA,EAAI,CAAA,OAAA,EAAU,QAAA,CAAS,UAAA,CAAW,OAAA,CAAQ,iBAAiB,GAAG,CAAC,CAAA,CAAA,EAAI,QAAA,CAAS,SAAS,CAAA,CAAA;AAAA,MACrF,MAAA,EAAQ,YAAA;AAAA,MACR,WAAA,EAAa,UAAA;AAAA,MACb,MAAM,QAAA,CAAS,SAAA;AAAA,MACf,IAAA,EAAM;AAAA,KACR;AAEA,IAAA,MAAM,mBAAmB,MAAM,CAAA;AAAA,EACjC,SAAS,KAAA,EAAO;AACd,IAAA,OAAA,CAAQ,KAAA,CAAM,sCAAsC,KAAK,CAAA;AACzD,IAAA,MAAM,KAAA;AAAA,EACR;AACF;AAKA,eAAsB,0BAA0B,OAAA,EAW9B;AAChB,EAAA,IAAI;AACF,IAAA,MAAM,MAAA,GAA0B;AAAA,MAC9B,IAAI,CAAA,cAAA,EAAiB,OAAA,CAAQ,QAAQ,CAAA,CAAA,EAAI,QAAQ,WAAW,CAAA,CAAA;AAAA,MAC5D,MAAA,EAAQ,eAAA;AAAA,MACR,WAAA,EAAa,iBAAA;AAAA,MACb,MAAM,OAAA,CAAQ,WAAA;AAAA,MACd,IAAA,EAAM;AAAA,KACR;AAEA,IAAA,MAAM,mBAAmB,MAAM,CAAA;AAAA,EACjC,SAAS,KAAA,EAAO;AACd,IAAA,OAAA,CAAQ,KAAA,CAAM,yCAAyC,KAAK,CAAA;AAC5D,IAAA,MAAM,KAAA;AAAA,EACR;AACF;AAKA,eAAsB,wBAAwB,QAAA,EAO5B;AAChB,EAAA,IAAI;AACF,IAAA,MAAM,MAAA,GAA0B;AAAA,MAC9B,IAAI,CAAA,SAAA,EAAY,QAAA,CAAS,YAAY,CAAA,CAAA,EAAI,SAAS,WAAW,CAAA,CAAA;AAAA,MAC7D,MAAA,EAAQ,qBAAA;AAAA,MACR,aAAa,QAAA,CAAS,YAAA;AAAA,MACtB,MAAM,QAAA,CAAS,WAAA;AAAA,MACf,IAAA,EAAM;AAAA,KACR;AAEA,IAAA,MAAM,mBAAmB,MAAM,CAAA;AAAA,EACjC,SAAS,KAAA,EAAO;AACd,IAAA,OAAA,CAAQ,KAAA,CAAM,sCAAsC,KAAK,CAAA;AACzD,IAAA,MAAM,KAAA;AAAA,EACR;AACF;AAKA,eAAsB,qBAAqB,KAAA,EAMzB;AAChB,EAAA,IAAI;AACF,IAAA,MAAM,MAAA,GAA0B;AAAA,MAC9B,IAAI,CAAA,WAAA,EAAc,KAAA,CAAM,MAAM,CAAA,CAAA,EAAI,MAAM,UAAU,CAAA,CAAA;AAAA,MAClD,MAAA,EAAQ,YAAA;AAAA,MACR,aAAa,KAAA,CAAM,MAAA;AAAA,MACnB,MAAM,KAAA,CAAM,UAAA;AAAA,MACZ,IAAA,EAAM;AAAA,KACR;AAEA,IAAA,MAAM,mBAAmB,MAAM,CAAA;AAAA,EACjC,SAAS,KAAA,EAAO;AACd,IAAA,OAAA,CAAQ,KAAA,CAAM,mCAAmC,KAAK,CAAA;AACtD,IAAA,MAAM,KAAA;AAAA,EACR;AACF;;;;"}