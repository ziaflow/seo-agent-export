{"version":3,"file":"0a7d2404-e63e-412c-8cc0-f401a2ecd734.mjs","sources":["../../../src/mastra/tools/automationDecisionTool.ts"],"sourcesContent":["import { createTool } from \"@mastra/core/tools\";\r\nimport { z } from \"zod\";\r\nimport { storeAutomationDecision } from \"../storage/analyticsDb\";\r\n\r\n/**\r\n * Automation Decision Tool\r\n * Consumes analytics inputs and outputs action recommendations.\r\n */\r\nexport const automationDecisionTool = createTool({\r\n  id: \"automation-decision\",\r\n  description:\r\n    \"Evaluates keyword gaps, schema issues, and performance data to decide if new content should be created.\",\r\n  inputSchema: z.object({\r\n    websiteUrl: z.string().url(),\r\n    keywordOpportunities: z\r\n      .array(\r\n        z.object({\r\n          keyword: z.string(),\r\n          opportunityScore: z.number(),\r\n          intent: z.string(),\r\n        }),\r\n      )\r\n      .default([]),\r\n    criticalSchemaIssues: z.number().int().default(0),\r\n    trafficTrend: z.enum([\"up\", \"flat\", \"down\"]).default(\"flat\"),\r\n  }),\r\n  outputSchema: z.object({\r\n    websiteUrl: z.string(),\r\n    decisionType: z.literal(\"content_generation\"),\r\n    shouldAct: z.boolean(),\r\n    confidence: z.number(),\r\n    reasons: z.array(z.string()),\r\n    evaluatedAt: z.string(),\r\n  }),\r\n  execute: async ({ context, mastra }) => {\r\n    const logger = mastra?.getLogger();\r\n    logger?.info(\"ðŸ§  [Decision Tool] Evaluating automation decision\");\r\n\r\n    const avgOpportunity =\r\n      context.keywordOpportunities.reduce((sum, item) => sum + item.opportunityScore, 0) /\r\n      (context.keywordOpportunities.length || 1);\r\n\r\n    const shouldAct =\r\n      avgOpportunity >= 70 || context.criticalSchemaIssues > 0 || context.trafficTrend === \"down\";\r\n\r\n    const reasons: string[] = [];\r\n    if (avgOpportunity >= 70) {\r\n      reasons.push(`High average opportunity score (${Math.round(avgOpportunity)})`);\r\n    }\r\n    if (context.criticalSchemaIssues > 0) {\r\n      reasons.push(`${context.criticalSchemaIssues} critical schema issue(s) detected`);\r\n    }\r\n    if (context.trafficTrend === \"down\") {\r\n      reasons.push(\"Traffic trending down\");\r\n    }\r\n\r\n    if (reasons.length === 0) {\r\n      reasons.push(\"Metrics within acceptable thresholds\");\r\n    }\r\n\r\n    const payload = {\r\n      websiteUrl: context.websiteUrl,\r\n      decisionType: \"content_generation\" as const,\r\n      shouldAct,\r\n      confidence: Math.min(0.95, 0.5 + reasons.length * 0.1),\r\n      reasons,\r\n      evaluatedAt: new Date().toISOString(),\r\n    };\r\n\r\n    await storeAutomationDecision(payload);\r\n    logger?.info(\"âœ… [Decision Tool] Decision stored\", { shouldAct });\r\n\r\n    return payload;\r\n  },\r\n});\r\n"],"names":[],"mappings":"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"}