{"version":3,"file":"api.js","names":["z","url: URL","getEnvVar","parseAsBoolean","fetchWithAuthFallback"],"sources":["../src/api.ts"],"sourcesContent":["import { z } from \"zod/v3\";\nimport { getEnvVar } from \"./env\";\nimport { fetchWithAuthFallback, parseAsBoolean } from \"./util\";\n\nconst tokenSchema = z.object({ jwt: z.string() });\n\nexport const api = {\n  async getSubscriptionToken({\n    channel,\n    topics,\n    signingKey,\n    signingKeyFallback,\n    apiBaseUrl,\n  }: {\n    channel: string;\n    topics: string[];\n    signingKey: string | undefined;\n    signingKeyFallback: string | undefined;\n    apiBaseUrl: string | undefined;\n  }): Promise<string> {\n    let url: URL;\n    const path = \"/v1/realtime/token\";\n    const inputBaseUrl =\n      apiBaseUrl ||\n      getEnvVar(\"INNGEST_BASE_URL\") ||\n      getEnvVar(\"INNGEST_API_BASE_URL\");\n\n    const devEnvVar = getEnvVar(\"INNGEST_DEV\");\n\n    if (inputBaseUrl) {\n      url = new URL(path, inputBaseUrl);\n    } else if (devEnvVar) {\n      try {\n        const devUrl = new URL(devEnvVar);\n        url = new URL(path, devUrl);\n      } catch {\n        if (parseAsBoolean(devEnvVar)) {\n          url = new URL(path, \"http://localhost:8288/\");\n        } else {\n          url = new URL(path, \"https://api.inngest.com/\");\n        }\n      }\n    } else {\n      url = new URL(\n        path,\n        getEnvVar(\"NODE_ENV\") === \"production\"\n          ? \"https://api.inngest.com/\"\n          : \"http://localhost:8288/\",\n      );\n    }\n\n    const body = topics.map((topic) => ({\n      channel,\n      name: topic,\n      kind: \"run\",\n    }));\n\n    const res = await fetchWithAuthFallback({\n      authToken: signingKey,\n      authTokenFallback: signingKeyFallback,\n      fetch,\n      url,\n      options: {\n        method: \"POST\",\n        body: JSON.stringify(body),\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n      },\n    });\n\n    if (!res.ok) {\n      throw new Error(\n        `Failed to get subscription token: ${res.status} ${\n          res.statusText\n        } - ${await res.text()}`,\n      );\n    }\n\n    const data = await res.json();\n    return tokenSchema.parse(data).jwt;\n  },\n};\n"],"mappings":";;;;;;AAIA,MAAM,cAAcA,SAAE,OAAO,EAAE,KAAKA,SAAE,QAAQ,EAAE,CAAC;AAEjD,MAAa,MAAM,EACjB,MAAM,qBAAqB,EACzB,SACA,QACA,YACA,oBACA,cAOkB;CAClB,IAAIC;CACJ,MAAM,OAAO;CACb,MAAM,eACJ,cACAC,sBAAU,mBAAmB,IAC7BA,sBAAU,uBAAuB;CAEnC,MAAM,YAAYA,sBAAU,cAAc;AAE1C,KAAI,aACF,OAAM,IAAI,IAAI,MAAM,aAAa;UACxB,UACT,KAAI;EACF,MAAM,SAAS,IAAI,IAAI,UAAU;AACjC,QAAM,IAAI,IAAI,MAAM,OAAO;SACrB;AACN,MAAIC,4BAAe,UAAU,CAC3B,OAAM,IAAI,IAAI,MAAM,yBAAyB;MAE7C,OAAM,IAAI,IAAI,MAAM,2BAA2B;;KAInD,OAAM,IAAI,IACR,MACAD,sBAAU,WAAW,KAAK,eACtB,6BACA,yBACL;CAGH,MAAM,OAAO,OAAO,KAAK,WAAW;EAClC;EACA,MAAM;EACN,MAAM;EACP,EAAE;CAEH,MAAM,MAAM,MAAME,mCAAsB;EACtC,WAAW;EACX,mBAAmB;EACnB;EACA;EACA,SAAS;GACP,QAAQ;GACR,MAAM,KAAK,UAAU,KAAK;GAC1B,SAAS,EACP,gBAAgB,oBACjB;GACF;EACF,CAAC;AAEF,KAAI,CAAC,IAAI,GACP,OAAM,IAAI,MACR,qCAAqC,IAAI,OAAO,GAC9C,IAAI,WACL,KAAK,MAAM,IAAI,MAAM,GACvB;CAGH,MAAM,OAAO,MAAM,IAAI,MAAM;AAC7B,QAAO,YAAY,MAAM,KAAK,CAAC;GAElC"}