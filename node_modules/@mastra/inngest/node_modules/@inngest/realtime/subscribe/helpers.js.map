{"version":3,"file":"helpers.js","names":["app: Inngest.Any | undefined","api: { signingKey?: string; signingKeyFallback?: string } | undefined","TokenSubscription","getEnvVar"],"sources":["../../src/subscribe/helpers.ts"],"sourcesContent":["import type { Inngest } from \"inngest\";\nimport { getEnvVar } from \"../env\";\nimport type { Realtime } from \"../types\";\nimport { TokenSubscription } from \"./TokenSubscription\";\n\n/**\n * TODO\n */\nexport const subscribe = async <\n  const InputChannel extends Realtime.Channel | string,\n  const InputTopics extends (keyof Realtime.Channel.InferTopics<\n    Realtime.Channel.AsChannel<InputChannel>\n  > &\n    string)[],\n  const TToken extends Realtime.Subscribe.Token<\n    Realtime.Channel.AsChannel<InputChannel>,\n    InputTopics\n  >,\n  const TOutput extends Realtime.Subscribe.StreamSubscription<TToken>,\n>(\n  /**\n   * TODO\n   */\n  token: {\n    /**\n     * TODO\n     */\n    app?: Inngest.Like;\n\n    /**\n     * TODO\n     */\n    channel: Realtime.Subscribe.InferChannelInput<InputChannel>;\n\n    /**\n     * TODO\n     */\n    topics: InputTopics;\n  },\n\n  /**\n   * TODO\n   */\n  callback?: Realtime.Subscribe.Callback<TToken>,\n): Promise<TOutput> => {\n  const app: Inngest.Any | undefined = token.app as Inngest.Any | undefined;\n  const api: { signingKey?: string; signingKeyFallback?: string } | undefined =\n    app?.[\"inngestApi\"];\n\n  // Allow users to specify public env vars for the target URLs, but do not\n  // allow this for signing keys, as they should never be on a client.\n  const maybeApiBaseUrl =\n    app?.apiBaseUrl ||\n    getEnvVar(\"INNGEST_BASE_URL\") ||\n    getEnvVar(\"INNGEST_API_BASE_URL\");\n\n  const maybeSigningKey =\n    api?.[\"signingKey\"] || getEnvVar(\"INNGEST_SIGNING_KEY\");\n\n  const maybeSigningKeyFallback =\n    api?.[\"signingKeyFallback\"] || getEnvVar(\"INNGEST_SIGNING_KEY_FALLBACK\");\n\n  const subscription = new TokenSubscription(\n    token as Realtime.Subscribe.Token,\n    maybeApiBaseUrl,\n    maybeSigningKey,\n    maybeSigningKeyFallback,\n  );\n\n  const retStream = subscription.getJsonStream();\n  const callbackStream = subscription.getJsonStream();\n\n  await subscription.connect();\n\n  const extras = {\n    getJsonStream: () => subscription.getJsonStream(),\n    getEncodedStream: () => subscription.getEncodedStream(),\n  };\n\n  if (callback) {\n    subscription.useCallback(callback, callbackStream);\n  } else {\n    callbackStream.cancel(\"Not needed\");\n  }\n\n  return Object.assign(retStream, extras) as unknown as TOutput;\n};\n\n/**\n * TODO\n */\nexport const getSubscriptionToken = async <\n  const InputChannel extends Realtime.Channel | string,\n  const InputTopics extends (keyof Realtime.Channel.InferTopics<\n    Realtime.Channel.AsChannel<InputChannel>\n  > &\n    string)[],\n  const TToken extends Realtime.Subscribe.Token<\n    Realtime.Channel.AsChannel<InputChannel>,\n    InputTopics\n  >,\n>(\n  /**\n   * TODO\n   */\n  app: Inngest.Like,\n\n  /**\n   * TODO\n   */\n  args: {\n    /**\n     * TODO\n     */\n    channel: Realtime.Subscribe.InferChannelInput<InputChannel>;\n\n    /**\n     * TODO\n     */\n    topics: InputTopics;\n  },\n): Promise<TToken> => {\n  const channelId =\n    typeof args.channel === \"string\" ? args.channel : args.channel.name;\n\n  if (!channelId) {\n    throw new Error(\"Channel ID is required to create a subscription token\");\n  }\n\n  const key = await (app as Inngest.Any)[\"inngestApi\"].getSubscriptionToken(\n    channelId,\n    args.topics,\n  );\n\n  const token = {\n    channel: channelId,\n    topics: args.topics,\n    key,\n  } as TToken;\n\n  return token;\n};\n"],"mappings":";;;;;;;AAQA,MAAa,YAAY,OAevB,OAoBA,aACqB;CACrB,MAAMA,MAA+B,MAAM;CAC3C,MAAMC,MACJ,MAAM;CAeR,MAAM,eAAe,IAAIC,4CACvB,OAXA,KAAK,cACLC,sBAAU,mBAAmB,IAC7BA,sBAAU,uBAAuB,EAGjC,MAAM,iBAAiBA,sBAAU,sBAAsB,EAGvD,MAAM,yBAAyBA,sBAAU,+BAA+B,CAOzE;CAED,MAAM,YAAY,aAAa,eAAe;CAC9C,MAAM,iBAAiB,aAAa,eAAe;AAEnD,OAAM,aAAa,SAAS;CAE5B,MAAM,SAAS;EACb,qBAAqB,aAAa,eAAe;EACjD,wBAAwB,aAAa,kBAAkB;EACxD;AAED,KAAI,SACF,cAAa,YAAY,UAAU,eAAe;KAElD,gBAAe,OAAO,aAAa;AAGrC,QAAO,OAAO,OAAO,WAAW,OAAO;;;;;AAMzC,MAAa,uBAAuB,OAclC,KAKA,SAWoB;CACpB,MAAM,YACJ,OAAO,KAAK,YAAY,WAAW,KAAK,UAAU,KAAK,QAAQ;AAEjE,KAAI,CAAC,UACH,OAAM,IAAI,MAAM,wDAAwD;CAG1E,MAAM,MAAM,MAAO,IAAoB,cAAc,qBACnD,WACA,KAAK,OACN;AAQD,QANc;EACZ,SAAS;EACT,QAAQ,KAAK;EACb;EACD"}