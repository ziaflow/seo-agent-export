{"version":3,"file":"channel.js","names":["channel: Realtime.Channel.Builder","channelDefinition: any","topics: Record<string, Realtime.Topic.Definition>","finalId: string","topic","extras: Record<string, unknown>"],"sources":["../src/channel.ts"],"sourcesContent":["import { topic } from \"./topic\";\nimport { type Realtime } from \"./types\";\n\n/**\n * TODO\n */\nexport const channel: Realtime.Channel.Builder = (\n  /**\n   * TODO\n   */\n  id,\n) => {\n  // eslint-disable-next-line prefer-const, @typescript-eslint/no-explicit-any\n  let channelDefinition: any;\n  const topics: Record<string, Realtime.Topic.Definition> = {};\n\n  const builder = (...args: unknown[]) => {\n    const finalId: string = typeof id === \"string\" ? id : id(...args);\n\n    const topicsFns = Object.entries(topics).reduce<\n      Record<string, (data: unknown) => Promise<Realtime.Message.Input>>\n    >((acc, [name, topic]) => {\n      acc[name] = createTopicFn(finalId, topic);\n\n      return acc;\n    }, {});\n\n    const channel: Realtime.Channel = {\n      name: finalId,\n      topics,\n      ...topicsFns,\n    };\n\n    return channel;\n  };\n\n  const extras: Record<string, unknown> = {\n    topics,\n    addTopic: (topic: Realtime.Topic.Definition) => {\n      topics[topic.name] = topic;\n\n      return channelDefinition;\n    },\n  };\n\n  channelDefinition = Object.assign(builder, extras);\n\n  return channelDefinition;\n};\n\n/**\n * TODO\n */\nexport const typeOnlyChannel = <\n  TChannelDef extends Realtime.Channel.Definition,\n  TId extends string = Realtime.Channel.Definition.InferId<TChannelDef>,\n  TTopics extends Record<\n    string,\n    Realtime.Topic.Definition\n  > = Realtime.Channel.Definition.InferTopics<TChannelDef>,\n  TOutput extends Realtime.Channel = Realtime.Channel<TId, TTopics>,\n>(\n  /**\n   * TODO\n   */\n  id: TId,\n) => {\n  const blankChannel = {\n    ...channel(id),\n    topics: new Proxy(\n      {},\n      {\n        get: (target, prop) => {\n          if (prop in target) {\n            return target[prop as keyof typeof target];\n          }\n\n          if (typeof prop === \"string\") {\n            return topic(prop);\n          }\n        },\n      },\n    ),\n  };\n\n  const ch = new Proxy(blankChannel, {\n    get: (target, prop) => {\n      if (prop in target) {\n        return target[prop as keyof typeof target];\n      }\n\n      if (typeof prop === \"string\") {\n        return createTopicFn(id, topic(prop));\n      }\n    },\n  });\n\n  return ch as unknown as TOutput;\n};\n\nconst createTopicFn = (channelId: string, topic: Realtime.Topic.Definition) => {\n  return async (data: unknown) => {\n    const schema = topic.getSchema();\n    if (schema) {\n      try {\n        await schema[\"~standard\"].validate(data);\n      } catch (err) {\n        console.error(\n          `Failed schema validation for channel \"${channelId}\" topic \"${topic.name}\":`,\n          err,\n        );\n        throw new Error(\"Failed schema validation\");\n      }\n    }\n\n    return {\n      channel: channelId,\n      topic: topic.name,\n      data,\n    };\n  };\n};\n"],"mappings":";;;;;;AAMA,MAAaA,WAIX,OACG;CAEH,IAAIC;CACJ,MAAMC,SAAoD,EAAE;CAE5D,MAAM,WAAW,GAAG,SAAoB;EACtC,MAAMC,UAAkB,OAAO,OAAO,WAAW,KAAK,GAAG,GAAG,KAAK;AAgBjE,SANkC;GAChC,MAAM;GACN;GACA,GAXgB,OAAO,QAAQ,OAAO,CAAC,QAEtC,KAAK,CAAC,MAAMC,aAAW;AACxB,QAAI,QAAQ,cAAc,SAASA,QAAM;AAEzC,WAAO;MACN,EAAE,CAAC;GAML;;CAKH,MAAMC,SAAkC;EACtC;EACA,WAAW,YAAqC;AAC9C,UAAOD,QAAM,QAAQA;AAErB,UAAO;;EAEV;AAED,qBAAoB,OAAO,OAAO,SAAS,OAAO;AAElD,QAAO;;;;;AAMT,MAAa,mBAYX,OACG;CACH,MAAM,eAAe;EACnB,GAAG,QAAQ,GAAG;EACd,QAAQ,IAAI,MACV,EAAE,EACF,EACE,MAAM,QAAQ,SAAS;AACrB,OAAI,QAAQ,OACV,QAAO,OAAO;AAGhB,OAAI,OAAO,SAAS,SAClB,QAAOA,oBAAM,KAAK;KAGvB,CACF;EACF;AAcD,QAZW,IAAI,MAAM,cAAc,EACjC,MAAM,QAAQ,SAAS;AACrB,MAAI,QAAQ,OACV,QAAO,OAAO;AAGhB,MAAI,OAAO,SAAS,SAClB,QAAO,cAAc,IAAIA,oBAAM,KAAK,CAAC;IAG1C,CAAC;;AAKJ,MAAM,iBAAiB,WAAmB,YAAqC;AAC7E,QAAO,OAAO,SAAkB;EAC9B,MAAM,SAASA,QAAM,WAAW;AAChC,MAAI,OACF,KAAI;AACF,SAAM,OAAO,aAAa,SAAS,KAAK;WACjC,KAAK;AACZ,WAAQ,MACN,yCAAyC,UAAU,WAAWA,QAAM,KAAK,KACzE,IACD;AACD,SAAM,IAAI,MAAM,2BAA2B;;AAI/C,SAAO;GACL,SAAS;GACT,OAAOA,QAAM;GACb;GACD"}