{"version":3,"file":"middleware.js","names":["InngestMiddleware","publish: Realtime.PublishFn"],"sources":["../src/middleware.ts"],"sourcesContent":["import { InngestMiddleware } from \"inngest\";\nimport { getAsyncCtx } from \"inngest/experimental\";\nimport type { Realtime } from \"./types\";\n\nexport const realtimeMiddleware = () => {\n  return new InngestMiddleware({\n    name: \"publish\",\n    init({ client }) {\n      return {\n        onFunctionRun({ ctx: { runId } }) {\n          return {\n            transformInput({ ctx: { step } }) {\n              const publish: Realtime.PublishFn = async (input) => {\n                const { topic, channel, data } = await input;\n\n                const store = await getAsyncCtx();\n                if (!store) {\n                  throw new Error(\n                    \"No ALS found, but is required for running `publish()`\",\n                  );\n                }\n\n                const publishOpts = {\n                  topics: [topic],\n                  channel,\n                  runId,\n                };\n\n                const action = async () => {\n                  const result = await client[\"inngestApi\"].publish(\n                    publishOpts,\n                    data,\n                  );\n\n                  if (!result.ok) {\n                    throw new Error(\n                      `Failed to publish event: ${result.error?.error}`,\n                    );\n                  }\n                };\n\n                // This could be a couple of different versions, but is now\n                // stable in the latter format.\n                const isExecutingStep =\n                  store.executingStep ||\n                  // biome-ignore lint/suspicious/noExplicitAny: Testing across version boundaries\n                  (store as any).execution?.executingStep;\n\n                return (\n                  isExecutingStep\n                    ? action()\n                    : step.run(`publish:${publishOpts.channel}`, action)\n                ).then(() => {\n                  // Always return the data passed in to the `publish` call.\n\n                  return data;\n                });\n              };\n\n              return {\n                ctx: {\n                  /**\n                   * TODO\n                   */\n                  publish,\n                },\n              };\n            },\n          };\n        },\n      };\n    },\n  });\n};\n\n// Re-export types from here, as this is used as a separate entrypoint now\nexport * from \"./types\";\n"],"mappings":";;;;;;AAIA,MAAa,2BAA2B;AACtC,QAAO,IAAIA,0BAAkB;EAC3B,MAAM;EACN,KAAK,EAAE,UAAU;AACf,UAAO,EACL,cAAc,EAAE,KAAK,EAAE,WAAW;AAChC,WAAO,EACL,eAAe,EAAE,KAAK,EAAE,UAAU;KAChC,MAAMC,UAA8B,OAAO,UAAU;MACnD,MAAM,EAAE,OAAO,SAAS,SAAS,MAAM;MAEvC,MAAM,QAAQ,6CAAmB;AACjC,UAAI,CAAC,MACH,OAAM,IAAI,MACR,wDACD;MAGH,MAAM,cAAc;OAClB,QAAQ,CAAC,MAAM;OACf;OACA;OACD;MAED,MAAM,SAAS,YAAY;OACzB,MAAM,SAAS,MAAM,OAAO,cAAc,QACxC,aACA,KACD;AAED,WAAI,CAAC,OAAO,GACV,OAAM,IAAI,MACR,4BAA4B,OAAO,OAAO,QAC3C;;AAWL,cAJE,MAAM,iBAEL,MAAc,WAAW,gBAItB,QAAQ,GACR,KAAK,IAAI,WAAW,YAAY,WAAW,OAAO,EACtD,WAAW;AAGX,cAAO;QACP;;AAGJ,YAAO,EACL,KAAK,EAIH,SACD,EACF;OAEJ;MAEJ;;EAEJ,CAAC"}